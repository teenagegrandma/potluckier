/**
 * Plugin for rewrite config file based on AMD module.
 *
 * @author Allex Wang (allex.wxn@gmail.com)
 */

var path = require('path')
  , fs = require('fs-x')
  , lang = require('lang-ext')
  , sha1sum = lang.crypto.sha1

// Rewrite app config module.
module.exports = function(configJs, options) {
  if (!fs.existsSync(configJs)) {
    return false
  }
  options = options || {}
  var libBase = options.libPrefix
  require('amd-config-parse').rewrite(configJs, function(o) {
    // resolve library paths.
    var paths = o.paths || (o.paths = {})
    lang.forEach(paths, function(v, k) {
      if (libBase && v.indexOf('lib/') === 0) {
        paths[k] = v.replace('lib/', libBase + '/')
      }
      // cleanup useless aliases
      if  (k === v) delete paths[k]
    })
    if (libBase && !paths.lib) {
      paths.lib = libBase
    }
    // Fix module urlArgs.
    o.urlArgs = 'v=' + sha1sum(options.version || Date.now()).substring(0, 16)
  })
  console.log('Rewrite app config, done.')
}
